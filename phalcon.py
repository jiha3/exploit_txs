import requests
from bs4 import BeautifulSoup
import json
import time

PHALCON_URL = "https://explorer.phalcon.xyz/tx/"
PHALCON_CACHE_DIR = "cache/phalcon"
headers = {'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_5) AppleWebKit/537.36 (KHTML, '
                               'like Gecko) Chrome/50.0.2661.102 Safari/537.36'}

balance_change = dict()
main_accounts = dict()

class Transaction:
    def __init__(self, url):
        self.chain = url.split('/')[-2]
        self.tx_hash = url.split('/')[-1]
    def set_sender(sender):
        self.sender = sender
    def set_receiver(receiver):
        self.receiver = receiver

def get_balance_change_from_tx(url):
    tx = Transaction(url)
    r = requests.get(f"{PHALCON_URL}/{tx.chain}/{tx.tx_hash}", headers = headers)
    #print(r)
    #r = requests.get(f"{url}", headers = headers)
    soup = BeautifulSoup(r.content, 'html.parser')
    next_data = str(soup.find(id="__NEXT_DATA__").string)
    next_data = json.loads(next_data)
    if next_data['props']['pageProps']['success']:
        data = next_data['props']['pageProps']['data']
        balances = data['balanceChanges']
        accounts = data['accountLabels']
        basicInfo = data['basicInfo']
        #fundFlow = data['fundFlow']
        #print(next_data)
        data_dict = dict()
        data_dict['changes'] = dict()
        changes = dict()
        token_info = dict()
        for bal in balances:
            changes[bal['account']] = list()
            asset_dict = dict()
            token_dict = dict()
            for asset in bal['assets']:
                for acc in accounts:
                    if (acc['address'] == asset['address']):
                        token_dict[acc['address']] = acc['label']
                asset_dict[asset['address']] = float(asset['amount'].replace(',','')) * (1.0 if asset['sign'] else -1.0)
                changes[bal['account']].append(asset_dict)
        for acc in accounts:
            acc_dict = dict()
            acc_dict[acc['address']] = acc['label']
        data_dict['changes'] = changes
        data_dict['token'] = token_dict
        #print(changes)
        
        with open(f"{PHALCON_CACHE_DIR}/{tx.chain}-{tx.tx_hash}", "w") as f:
            json.dump(data_dict, f)
    else:
        #print(next_data['props']['pageProps']['msg'])
        time.sleep(10)
    
if __name__ == "__main__":
    get_balance_change_from_tx('https://explorer.phalcon.xyz/tx/eth/0xe0b0c2672b760bef4e2851e91c69c8c0ad135c6987bbf1f43f5846d89e691428')
    get_balance_change_from_tx('https://explorer.phalcon.xyz/tx/optimism/0xae17b8a15e09e737a0ab27802a15a23ec7168f1141a5556abe5a3d9e71d7396a')